package com.scc.server;

import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;
import org.springframework.web.bind.annotation.RestController;
import org.springframework.web.servlet.mvc.method.annotation.SseEmitter;

import java.io.IOException;

@RestController
public class SseDemoController {

    @RequestMapping(value = "/sse-demo", produces = "text/event-stream", method = RequestMethod.GET)
    public SseEmitter  streamData() {
        //创建sseEmitter对象, 设置超时时间300s
        SseEmitter sseEmitter = new SseEmitter(300000L);

        //异步任务模拟流式输出
        new Thread( () -> {
            try {
                for (int i = 0; i <= 20; i++) {
                    String message = "第" + i + "条消息";
                    sseEmitter.send(message);
                    Thread.sleep(300);// 每300ms发送一次
                }
                sseEmitter.complete();// 完成推送
            } catch (IOException | InterruptedException e) {
                sseEmitter.completeWithError(e);
            }

        }).start();
        return sseEmitter;
    }

    @RequestMapping(value = "/sse-demo2", produces = "text/event-stream", method = RequestMethod.GET)
    public SseEmitter  streamData2() {
        //创建sseEmitter对象, 设置超时时间300s
        SseEmitter sseEmitter = new SseEmitter(200000L);
        String originalString = "# 交通安全培训\n" +
                "## 交通安全重要性\n" +
                "### 交通安全的社会意义\n" +
                "#### 减少交通事故发生\n" +
                "* 据公安部统计，2022年全国共发生道路交通事故约24万起，造成6.2万人死亡，通过加强交通安全管理，可有效降低事故发生率，减少人员伤亡和经济损失，提升社会运行效率。\n" +
                "\n" +
                "#### 保护人民生命财产安全\n" +
                "* 交通事故是全球范围内导致意外死亡的主要原因之一，我国每年因交通事故造成的直接经济损失超过百亿元，强化交通安全措施可切实保障人民群众的生命权与财产权。\n" +
                "\n" +
                "#### 提升公众安全意识\n" +
                "* 通过系统化宣传教育，公众对交通规则的认知率提升至78%以上，北京、上海等地试点社区安全教育项目后，行人闯红灯行为下降43%，显著改善交通秩序。\n" +
                "\n" +
                "### 交通安全的法规基础\n" +
                "#### 交通安全法律法规概览\n" +
                "* 《中华人民共和国道路交通安全法》自2004年实施以来，历经多次修订，涵盖车辆管理、驾驶员行为规范、道路通行规则等内容，构成我国交通安全管理的法律核心框架。\n" +
                "\n" +
                "#### 交通违法行为的法律责任\n" +
                "* 酒驾行为依据《道路交通安全法》第九十一条，处以1000元以上2000元以下罚款并暂扣驾驶证6个月；造成重大事故者将依法追究刑事责任，最高可判处有期徒刑。\n" +
                "\n" +
                "## 交通事故原因分析\n" +
                "### 人为因素\n" +
                "#### 驾驶员疲劳驾驶\n" +
                "* 数据显示，连续驾驶超过4小时未休息的驾驶员发生事故的概率增加3倍，2021年江苏一起大巴侧翻事故即因司机连续工作12小时导致疲劳驾驶引发。\n" +
                "\n" +
                "#### 酒驾、毒驾危害\n" +
                "* 全国酒驾查处量年均超30万起，酒精使驾驶员反应时间延长30%以上，视觉判断力下降50%，极易引发恶性事故，严重威胁公共安全。\n" +
                "\n" +
                "#### 行人与非机动车违规行为\n" +
                "* 深圳市2022年数据显示，约37%的交通事故涉及行人或非机动车闯红灯、逆行等行为，尤以电动自行车违规载人、占用机动车道问题突出。\n" +
                "\n" +
                "### 车辆因素\n" +
                "#### 车辆机械故障导致的事故\n" +
                "* 国家质检总局数据显示，刹车失灵、轮胎爆裂等机械故障占交通事故成因的12%，部分老旧货运车辆因保养不到位存在重大安全隐患。\n" +
                "\n" +
                "#### 超速、超载的潜在风险\n" +
                "* 超速行驶使制动距离显著延长，车速提高20%，事故致死率上升50%；超载10%以上车辆刹车性能下降30%，易引发侧翻或追尾事故。\n" +
                "\n" +
                "### 道路与环境因素\n" +
                "#### 道路设计缺陷与维护不足\n" +
                "* 山区急弯路段缺乏警示标志或防护栏，2020年云南某县连续三起坠崖事故均与此类道路缺陷有关，道路养护不及时也加剧了安全隐患。\n" +
                "\n" +
                "#### 恶劣天气对交通安全的影响\n" +
                "* 雨雪天气下道路湿滑系数降低40%以上，能见度下降至50米以内时，高速公路事故率上升2倍，需采取限速、封闭等应急管控措施。\n" +
                "\n" +
                "## 交通安全法规详解\n" +
                "### 交通信号灯规则\n" +
                "#### 红灯停、绿灯行原则\n" +
                "* 依据《道路交通安全法实施条例》第三十八条，红灯亮时禁止通行，违者处200元罚款并记6分；绿灯亮时准许通行，但须确保安全通过路口。\n" +
                "\n" +
                "#### 黄灯警示作用\n" +
                "* 黄灯持续时间为3至5秒，提示车辆即将禁行，提前进入路口的可继续通行，抢黄灯行为已被多地纳入电子监控抓拍范围，存在安全与处罚双重风险。\n" +
                "\n" +
                "### 道路标线与标志\n" +
                "#### 各类标线含义与遵守\n" +
                "* 白色实线禁止变道，黄色虚线允许借道超车，双黄实线严禁跨越；北京主干道施划“左转待转区”后，路口通行效率提升22%，违规压线行为同比下降35%。\n" +
                "\n" +
                "#### 警告、禁令、指示标志识别\n" +
                "* 三角形红边为警告标志，如“急弯慢行”；圆形红圈为禁令标志，如“禁止停车”；矩形蓝底为指示标志，如“直行车道”，识别准确率需达90%以上方可保障安全。\n" +
                "\n" +
                "### 行车安全规定\n" +
                "#### 保持安全车距\n" +
                "* 高速公路行驶时，车速100km/h应保持100米以上距离，实测数据显示，保持安全车距可使追尾事故减少60%，是预防连环碰撞的关键措施。\n" +
                "\n" +
                "#### 正确使用转向灯\n" +
                "* 变道或转弯前3秒开启转向灯，深圳交警数据显示，未打灯变道引发事故占比达18%，规范使用可提升其他车辆预判能力，降低碰撞风险。\n" +
                "\n" +
                "#### 避免盲区行驶\n" +
                "* 大型车辆存在前后左右多个盲区，距离车体左侧1米、后方5米范围内为高危区域，小型车辆应避免在其盲区长时间停留，防止突发变道引发事故。\n" +
                "\n" +
                "## 交通安全技能培训\n" +
                "### 驾驶员安全驾驶技巧\n" +
                "#### 防御性驾驶策略\n" +
                "* 通过预判潜在风险、保持缓冲空间、持续观察周围环境等方法，可降低事故概率达50%以上，美国卡车协会推广该技术后驾驶员事故率下降44%。\n" +
                "\n" +
                "#### 紧急情况应对方法\n" +
                "* 遇爆胎时应紧握方向盘、轻踩刹车缓慢减速，避免急刹；车辆打滑时应反打方向修正，成都驾校模拟训练显示，受训学员应急处置成功率提高70%。\n" +
                "\n" +
                "### 行人与非机动车安全出行\n" +
                "#### 横穿马路注意事项\n" +
                "* 应走人行横道或过街天桥，遵守信号灯指示，观察来车方向不少于两次，儿童需由成人带领通行，广州实施“斑马线礼让”后行人事故下降28%。\n" +
                "\n" +
                "#### 骑行安全与防护装备\n" +
                "* 电动自行车骑行者佩戴头盔可降低头部损伤风险70%，上海规定未戴头盔者罚款50元，同时禁止加装遮阳伞、超速改装等危险行为。\n" +
                "\n" +
                "### 特殊天气驾驶技巧\n" +
                "#### 雨天路滑驾驶要点\n" +
                "* 保持低速行驶，避免急加速或急转弯，雨刮器须正常工作，轮胎花纹深度低于1.6mm时制动距离增加40%，应及时更换以保障抓地力。\n" +
                "\n" +
                "#### 雾天行车安全提示\n" +
                "* 能见度低于100米时开启雾灯、近光灯和危险报警闪光灯，车速不得超过40km/h，禁止使用远光灯造成眩目，必要时驶离高速或靠边停车等待。\n" +
                "\n" +
                "## 交通安全案例分析\n" +
                "### 典型交通事故案例\n" +
                "#### 酒驾引发的严重事故\n" +
                "* 2020年浙江温岭一起酒驾宝马冲入人群事故致12死18伤，驾驶员血液酒精含量达158mg/100ml，法院以危险方法危害公共安全罪判处死刑。\n" +
                "\n" +
                "#### 疲劳驾驶导致的追尾\n" +
                "* 2022年京港澳高速一辆货车因司机连续驾驶18小时后打盹，追尾前方客车致5人死亡，调查认定企业未落实驾驶员休息制度，承担连带责任。\n" +
                "\n" +
                "### 案例分析与教训总结\n" +
                "#### 事故原因分析\n" +
                "* 经调查，83%的重大交通事故存在人为操作失误，其中酒驾、超速、疲劳驾驶为主要诱因，车辆状况不良和道路设计缺陷占比分别为12%和5%。\n" +
                "\n" +
                "#### 预防措施与建议\n" +
                "* 建议推广车载酒精锁、疲劳监测系统，强化企业动态监控平台应用，实施驾驶员健康档案管理，从源头遏制高风险行为发生。\n" +
                "\n" +
                "## 提升交通安全意识\n" +
                "### 公众交通安全教育\n" +
                "#### 定期开展交通安全宣传活动\n" +
                "* 全国“122交通安全日”每年覆盖超2亿人次，各地学校、社区组织讲座、演练等活动，武汉2023年开展进校园宣讲1200场，学生守法率提升至89%。\n" +
                "\n" +
                "#### 利用媒体扩大宣传覆盖面\n" +
                "* 中央电视台《平安行》节目年均收视超1.5亿，短视频平台发布交通安全警示片累计播放量突破50亿次，有效提升公众认知与行为改变。\n" +
                "\n" +
                "### 企业与单位责任\n" +
                "#### 加强员工交通安全培训\n" +
                "* 滴滴出行对司机每季度开展线上安全课程，完课率要求达100%，顺丰快递员入职须通过交通法规考试，违规者暂停接单并重新培训。\n" +
                "\n" +
                "#### 落实交通安全管理制度\n" +
                "* 危险品运输企业须配备GPS监控系统，实时跟踪车辆速度与路线，发现超速即刻预警，天津某物流公司因未监控被处以10万元罚款并停业整顿。\n" +
                "\n" +
                "### 家庭与个人行动\n" +
                "#### 家长以身作则教育子女\n" +
                "* 家庭是交通安全教育的第一课堂，父母遵守信号灯、系安全带的行为对儿童形成正向示范，调查显示有家长引导的孩子守法率高出40%。\n" +
                "\n" +
                "#### 个人自觉遵守交通规则\n" +
                "* 每位交通参与者应主动抵制闯红灯、乱穿马路、开车接打电话等行为，北京地铁站试点“文明出行积分”制度，累计良好记录可兑换乘车优惠。";

        //获取分割后的字符串数组
        String[] split = originalString.split("\\n");
        //异步任务模拟流式输出
        new Thread( () -> {
            try {
                //遍历数组中的元素, 放入sseEmitter中
                for (String s : split) {
                    sseEmitter.send(s);
                    Thread.sleep(1000);
                }
                sseEmitter.complete();// 完成推送
            } catch (IOException | InterruptedException e) {
                sseEmitter.completeWithError(e);
            }

        }).start();
        return sseEmitter;
    }

}
