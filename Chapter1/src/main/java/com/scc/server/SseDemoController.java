package com.scc.server;

import org.springframework.http.codec.ServerSentEvent;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;
import org.springframework.web.bind.annotation.RestController;
import org.springframework.web.servlet.mvc.method.annotation.SseEmitter;

import javax.servlet.http.HttpServletResponse;
import java.io.IOException;
import java.io.PrintWriter;

@RestController
public class SseDemoController {

    @RequestMapping(value = "/sse-demo", produces = "text/event-stream", method = RequestMethod.GET)
    public SseEmitter  streamData() {
        //创建sseEmitter对象, 设置超时时间300s
        SseEmitter sseEmitter = new SseEmitter(300000L);

        //异步任务模拟流式输出
        new Thread( () -> {
            try {
                for (int i = 0; i <= 20; i++) {
                    String message = "第" + i + "条消息";
                    sseEmitter.send(message);
                    Thread.sleep(300);// 每300ms发送一次
                }
                sseEmitter.complete();// 完成推送
            } catch (IOException | InterruptedException e) {
                sseEmitter.completeWithError(e);
            }

        }).start();
        return sseEmitter;
    }

    @RequestMapping(value = "/sse-demo2", produces = "text/event-stream", method = {RequestMethod.GET,
            RequestMethod.POST})
    public SseEmitter  streamData2() {
        //创建sseEmitter对象, 设置超时时间300s
        SseEmitter sseEmitter = new SseEmitter(200000L);
        String originalString = "#  田忌赛马小学语文教案\n" +
                "##  故事背景介绍\n" +
                "###  战国时期齐国赛马故事\n";

        //获取分割后的字符串数组
        String[] split = originalString.split("\\n");
        //异步任务模拟流式输出
        new Thread( () -> {
            try {
                //遍历数组中的元素, 放入sseEmitter中
                for (String s : split) {
                    sseEmitter.send(ServerSentEvent.builder(s).build());
                    Thread.sleep(1000);
                }
                sseEmitter.complete();// 完成推送
            } catch (IOException | InterruptedException e) {
                sseEmitter.completeWithError(e);
            }

        }).start();
        return sseEmitter;
    }

    @RequestMapping(value = "/sse-demo3", method = {RequestMethod.GET, RequestMethod.POST})
    public void customSseStream(HttpServletResponse response) {
        response.setContentType("text/event-stream");
        response.setCharacterEncoding("UTF-8");
        response.setHeader("Cache-Control", "no-cache");
        response.setHeader("Connection", "keep-alive");

        String originalString = "# 田忌赛马小学语文教案  \n" +
                "## 故事背景介绍  \n" +
                "### 战国时期齐国赛马故事  \n" +
                "* 战国时期齐国盛行赛马，贵族常以此比试财力与策略，田忌为齐国大将，酷爱赛马，常与齐威王对赛。  \n" +
                "* 赛事规则为三局两胜制，马分上、中、下三等，同等级马匹比赛，胜负取决于马速与骑术。  \n" +
                "* 该故事出自《史记·孙子吴起列传》，反映古代军事谋略在日常竞技中的巧妙运用。  \n" +
                "\n" +
                "### 田忌与齐威王对决  \n" +
                "* 田忌多次败于齐威王，每场比赛均以同等级马匹对战，结果三局皆输，损失千金。  \n" +
                "* 齐威王马匹精良，自恃实力强，常在宫廷设赛，吸引文武百官观战，场面盛大。  \n" +
                "* 此次对决成为转折点，因孙膑观赛后提出调换出场顺序，助田忌反败为胜。  \n" +
                "\n" +
                "### 赛马背景与意义  \n" +
                "* 赛马不仅是娱乐活动，更是地位与威望的象征，胜利者可获得政治声望与君主赏识。  \n" +
                "* 当时兵法思想盛行，孙膑将军事策略融入赛马，体现“以弱胜强”的战术智慧。  \n" +
                "* 此事推动谋略文化在民间传播，成为后世教育中的经典案例。  \n" +
                "\n" +
                "### 故事寓意初探  \n" +
                "* 故事揭示面对强敌时，不应仅凭实力硬拼，而应通过策略调整实现逆转。  \n" +
                "* 强调思维转变的重要性，即使资源劣势，也能通过合理安排取得胜利。  \n" +
                "* 为学生提供初步的逻辑思维启蒙，引导其理解“换位思考”与“策略规划”。  \n" +
                "\n" +
                "## 生字生词学习  \n" +
                "### 生字：忌、逊、蔑  \n" +
                "* “忌”读jì，部首为“心”，本义为嫉妒，文中指田忌之名，亦含避讳之意。  \n" +
                "* “逊”读xùn，部首为“辶”，意为谦让或差于，如“稍逊一筹”，体现等级差距。  \n" +
                "* “蔑”读miè，部首为“艹”，意为轻视，如“轻蔑”，形容齐威王对田忌的不屑态度。  \n" +
                "\n" +
                "### 生词：摩拳擦掌、胸有成竹  \n" +
                "* “摩拳擦掌”形容准备行动时的兴奋状态，文中描绘参赛者赛前积极备战的情景。  \n" +
                "* “胸有成竹”比喻做事前已有全面计划，孙膑提出策略时表现从容自信。  \n" +
                "* 两词均用于刻画人物心理，增强故事的紧张感与人物形象的立体性。  \n" +
                "\n" +
                "### 生字读音与笔顺  \n" +
                "* “忌”共7画，笔顺为撇、横折钩、点、斜钩、点、点、点，注意斜钩舒展。  \n" +
                "* “逊”共9画，笔顺为横撇、横钩、竖钩、提、横折折撇、捺，走之旁需流畅。  \n" +
                "* “蔑”共14画，笔顺起于草字头，下接“罒”与“戍”，书写时注意结构紧凑。  \n" +
                "\n" +
                "### 生词意思与例句  \n" +
                "* “摩拳擦掌”例句：运动员们摩拳擦掌，准备在运动会上大展身手。  \n" +
                "* “胸有成竹”例句：老师提问前，他早已想好答案，回答时胸有成竹。  \n" +
                "* 结合课文语境，帮助学生理解词语在具体情境中的情感色彩与使用方式。  \n" +
                "\n" +
                "## 课文内容分析  \n" +
                "### 第一段：赛马起因  \n" +
                "* 田忌常与齐威王赛马，双方马匹等级相当，但因出场顺序固定，田忌屡战屡败。  \n" +
                "* 每次比赛三局两胜，田忌用上等马对上等马，结果全输，经济损失严重。  \n" +
                "* 起因部分铺垫矛盾，为后文孙膑献策提供必要的情节基础与问题情境。  \n" +
                "\n" +
                "### 第二段：孙膑献策  \n" +
                "* 孙膑观察比赛后指出，可通过调整马匹出场顺序改变胜负结果。  \n" +
                "* 具体策略为：以下等马对上等马，输第一局；以上等马对中等马，中等马对下等马，赢后两局。  \n" +
                "* 此策利用规则漏洞，牺牲局部利益换取整体胜利，体现战略思维的核心。  \n" +
                "\n" +
                "### 第三段：比赛过程  \n" +
                "* 第一场田忌派下等马对阵齐威王上等马，明显落败，齐威王得意洋洋。  \n" +
                "* 第二场田忌以上等马对中等马，轻松取胜；第三场中等马对下等马，再胜一局。  \n" +
                "* 比赛过程紧张有序，通过对比描写突出策略实施后的戏剧性转变。  \n" +
                "\n" +
                "### 第四段：比赛结果  \n" +
                "* 田忌以二比一战胜齐威王，赢得千金赌注，全场震惊，齐威王惊叹其策略高明。  \n" +
                "* 齐威王询问获胜原因，田忌如实相告，引荐孙膑，使其获得重用。  \n" +
                "* 结果不仅改变个人命运，也体现智慧人才在国家治理中的重要价值。  \n" +
                "\n" +
                "### 课文重点句子解析  \n" +
                "* “还是原来的马，只调换了一下出场顺序，就可以转败为胜。”强调方法的重要性。  \n" +
                "* “齐威王好奇地问：‘你这样安排马的出场顺序，是不是有必胜的把握？’”体现其疑惑与震惊。  \n" +
                "* 句子结构简洁有力，通过对话推进情节，突出主题思想，适合学生朗读与模仿。  \n" +
                "\n" +
                "## 人物形象探讨  \n" +
                "### 田忌：豪爽直率  \n" +
                "* 田忌性格坦率，赛马输钱不掩饰情绪，愿听他人建议，体现开放包容的品格。  \n" +
                "* 作为武将，虽不善谋略，但尊重人才，赛后主动推荐孙膑，展现领导胸襟。  \n" +
                "* 其形象贴近现实人物，有缺点但能改正，为学生树立勇于接受帮助的榜样。  \n" +
                "\n" +
                "### 孙膑：足智多谋  \n" +
                "* 孙膑善于观察，能从常规比赛中发现破局关键，提出逆向思维解决方案。  \n" +
                "* 其策略基于对对手心理与规则的精准把握，体现军事家的冷静与智慧。  \n" +
                "* 作为谋士代表，他以智取胜，成为中华文化中“智者”的典型象征。  \n" +
                "\n" +
                "### 齐威王：骄傲自负  \n" +
                "* 齐威王凭借强大马匹屡胜不败，赛前轻视对手，表现出典型的骄傲心态。  \n" +
                "* 比赛后虽惊叹孙膑之策，但未恼怒，反而接纳建议，体现明君应有的胸怀。  \n" +
                "* 其性格转变反映领导者从自负到理性认知的过渡，具有教育意义。  \n" +
                "\n" +
                "### 人物性格对比赛影响  \n" +
                "* 田忌的直率使其愿意听取建议，为孙膑介入提供可能，促成策略实施。  \n" +
                "* 孙膑的智慧直接决定比赛走向，其冷静分析是反败为胜的核心动力。  \n" +
                "* 齐威王的自负导致轻敌，未预判策略变化，成为被智取的关键因素。  \n" +
                "\n" +
                "## 主题思想提炼  \n" +
                "### 智慧胜于蛮力  \n" +
                "* 田忌原有马匹实力不如齐威王，但通过策略调整实现逆转，证明智慧高于力量。  \n" +
                "* 故事告诉学生，在学习与生活中遇到困难时，应多动脑筋寻找解决办法。  \n" +
                "* 类似案例包括草船借箭、空城计等，均体现中国古代智慧文化的精髓。  \n" +
                "\n" +
                "### 知己知彼百战不殆  \n" +
                "* 孙膑深入了解双方马匹实力与比赛规则，才能制定出精准对策。  \n" +
                "* 该思想源自《孙子兵法》，强调信息收集与分析在决策中的决定性作用。  \n" +
                "* 教学中可引导学生联系实际，如考试复习需了解自身薄弱环节。  \n" +
                "\n" +
                "### 善于利用优势  \n" +
                "* 田忌虽整体马力较弱，但孙膑发现其上等马对中等马具有绝对优势。  \n" +
                "* 策略核心在于集中优势兵力打歼灭战，避开强敌，攻击弱点，实现局部优势。  \n" +
                "* 此原则适用于团队分工、学习计划制定等多个现实场景。  \n" +
                "\n" +
                "### 团队合作的重要性  \n" +
                "* 田忌与孙膑的合作是胜利关键，一人提供资源，一人贡献智慧，缺一不可。  \n" +
                "* 故事体现“术业有专攻”，个人能力有限，唯有协作才能达成目标。  \n" +
                "* 课堂可延伸讨论小组合作学习的意义，培养学生集体意识与协作精神。  \n" +
                "\n" +
                "## 写作技巧总结  \n" +
                "### 叙事结构清晰  \n" +
                "* 课文按起因—经过—结果顺序展开，层次分明，符合小学生认知规律。  \n" +
                "* 四段式结构紧凑，每段聚焦一个情节节点，便于学生复述与理解。  \n" +
                "* 时间线索明确，逻辑递进自然，有助于训练学生的叙事表达能力。  \n" +
                "\n" +
                "### 人物形象鲜明  \n" +
                "* 通过语言、动作与心理描写塑造人物，如齐威王“得意扬扬”，田忌“垂头丧气”。  \n" +
                "* 不同人物性格对比强烈，形成张力，增强故事可读性与教育意义。  \n" +
                "* 人物语言符合身份特征，将军豪爽、谋士沉稳、君王威严，各具特色。  \n" +
                "\n" +
                "### 对话生动自然  \n" +
                "* 关键情节通过对话推进，如孙膑献策、齐威王发问，使叙述更富现场感。  \n" +
                "* 对话简短有力，无冗余表达，符合口语特点，适合学生模仿与表演。  \n" +
                "* 有效传达信息同时展现人物关系，增强文本的表现力与感染力。  \n" +
                "\n" +
                "### 细节描写突出  \n" +
                "* “摩拳擦掌”“目瞪口呆”等细节描写增强画面感，帮助学生想象比赛场景。  \n" +
                "* 马匹出场顺序的变化被具体描述，使策略实施过程清晰可见。  \n" +
                "* 细节服务于主题，既推动情节发展，又深化人物性格与思想内涵。  \n" +
                "\n" +
                "## 课堂互动环节设计  \n" +
                "### 分角色朗读课文  \n" +
                "* 学生分别扮演田忌、孙膑、齐威王和旁白，通过语气变化表现人物情绪。  \n" +
                "* 朗读时注意停顿与重音，如“只调换了一下出场顺序”需强调“调换”。  \n" +
                "* 活动提升语感与表达能力，加深对人物性格与情节发展的理解。  \n" +
                "\n" +
                "### 生字生词接龙游戏  \n" +
                "* 教师出示“忌”字，学生接“忌—忌惮—摩拳擦掌—掌上明珠”等词语接龙。  \n" +
                "* 游戏规则为前词尾字作后词首字，限时一分钟，答对最多者获胜。  \n" +
                "* 通过趣味活动巩固词汇记忆，提高学生参与积极性与语言运用能力。  \n" +
                "\n" +
                "### 小组讨论：如果你是孙膑会怎样献策  \n" +
                "* 学生分组讨论其他可能策略，如更换骑手、调整训练方式等替代方案。  \n" +
                "* 每组推选代表发言，教师点评其可行性与创新性，鼓励多元思维。  \n" +
                "* 讨论激发想象力，培养学生批判性思维与问题解决能力。  \n" +
                "\n" +
                "### 情景模拟：赛马现场重现  \n" +
                "* 利用课桌模拟赛道，学生手持马匹卡片扮演不同等级马匹进行三局比赛。  \n" +
                "* 一组按原顺序比赛，另一组采用孙膑策略，对比结果验证策略有效性。  \n" +
                "* <活动增强体验感，将抽象策略具象化，帮助学生直观理解智慧的力量。  \n" +
                "\n" +
                "## 课后作业布置  \n" +
                "### 熟读课文并背诵重点段落  \n" +
                "* 要求学生通读全文三遍，重点背诵第二、三段孙膑献策与比赛过程。  \n" +
                "* 家长协助检查背诵情况，\"签字确认，培养良好学习习惯与家庭监督机制。  \n" +
                "* 背诵提升语言积累，为后续复述与写作打下坚实基础。  \n" +
                "\n" +
                "### 书写本课生字生词各五遍  \n" +
                "* 在田字格本上规范书写“忌、逊、蔑”及“摩拳擦掌、胸有成竹”各五遍。  \n" +
                "* 注意笔顺正确、结构匀称，教师次日检查书写质量并给予等级评价。  \n" +
                "* 书写训练强化记忆，纠正错误笔顺，提升汉字书写规范性。  \n" +
                "\n" +
                "### 完成课后习题巩固知识  \n" +
                "* 完成教材配套练习册中字词填空、句子排序与阅读理解题共10小题。  \n" +
                "* 题目涵盖生字辨析、词语运用与内容理解，全面检测学习效果。  \n" +
                "* 作业30-50分钟完成，培养时间管理意识与独立答题能力。  \n" +
                "\n" +
                "### 想象作文：田忌赛马后续故事  \n" +
                "* \n" +
                "以“第二次赛马”为题，写一篇不少于200字的续写作文，设想新的情节发展。  \n" +
                "* \n" +
                "可设想齐威王调整策略反制，或孙膑再出奇招，鼓励创造性思维。  \n" +
                "* \n" +
                "作文要求结构完整、语句通顺，体现对原文主题的延续与拓展。";

        //获取分割后的字符串数组
        String[] split = originalString.split("\\n");
        try {

            PrintWriter writer = response.getWriter();
            // 自定义格式1：无前缀纯文本
            for (String s : split) {
                writer.write(s + "\n");
                writer.flush();
                Thread.sleep(200);
            }
        }  catch (InterruptedException | IOException e) {
            e.printStackTrace();
        }
    }

}
